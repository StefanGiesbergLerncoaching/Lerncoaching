<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Oberlängen-Text-Generator | Giesberg Diagnostik</title>
  <link rel="stylesheet" href="../../shared/css/giesberg-design.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* Tool-spezifische Styles (minimal, baut auf Design-System) */
    .tool-container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--space-xl);
    }

    .controls-panel {
      background: var(--color-white);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-sm);
      padding: var(--space-xl);
      margin-bottom: var(--space-xl);
    }

    .control-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: var(--space-lg);
    }

    .value-badge {
      display: inline-flex;
      align-items: center;
      background: var(--color-primary);
      color: var(--color-white);
      padding: 2px 12px;
      border-radius: 999px;
      font-size: var(--font-size-sm);
      font-weight: 600;
      min-width: 55px;
      text-align: center;
    }

    .replacements-panel {
      background: var(--color-white);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-sm);
      padding: var(--space-xl);
      margin-bottom: var(--space-xl);
    }

    .replacement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: var(--space-md);
    }

    .replacement-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      cursor: pointer;
    }

    .replacement-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--color-primary);
    }

    .custom-replacements {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-md);
      margin-top: var(--space-lg);
      padding-top: var(--space-lg);
      border-top: 1px solid var(--color-border);
    }

    .custom-replacement-row {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .custom-replacement-row input[type="text"] {
      width: 55px;
      padding: var(--space-xs) var(--space-sm);
      border: 2px solid var(--color-border);
      border-radius: var(--border-radius);
      font-family: var(--font-mono);
      font-size: 1rem;
      text-align: center;
    }

    .custom-replacement-row input[type="text"]:focus {
      border-color: var(--color-primary);
      outline: none;
    }

    .shuffle-toggle {
      background: var(--color-accent-light);
      border: 2px solid var(--color-accent);
      border-radius: var(--border-radius-lg);
      padding: var(--space-md) var(--space-lg);
      margin-bottom: var(--space-xl);
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .shuffle-toggle input[type="checkbox"] {
      width: 22px;
      height: 22px;
      cursor: pointer;
      accent-color: var(--color-accent);
    }

    .shuffle-toggle label {
      cursor: pointer;
      font-weight: 600;
      color: var(--color-accent-hover);
    }

    .shuffle-toggle .hint {
      font-size: var(--font-size-sm);
      color: var(--color-accent-hover);
      opacity: 0.8;
    }

    .button-bar {
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
      margin-bottom: var(--space-xl);
    }

    .preview-panel {
      background: var(--color-white);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-sm);
      padding: var(--space-xl);
    }

    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-lg);
      padding-bottom: var(--space-md);
      border-bottom: 1px solid var(--color-border);
    }

    .preview-header h2 {
      margin-bottom: 0;
    }

    .preview-stats {
      color: var(--color-text-light);
      font-size: var(--font-size-sm);
    }

    .preview-text {
      font-family: 'Arial', sans-serif;
      color: #000;
      line-height: 1.8;
      padding: var(--space-lg);
      background: var(--color-light);
      border-radius: var(--border-radius);
      min-height: 250px;
    }

    .clipped-text {
      display: inline-block;
      transition: clip-path 0.3s ease;
    }

    /* Format-Toolbar */
    .format-toolbar {
      display: flex;
      gap: 4px;
      padding: var(--space-sm);
      background: var(--color-light);
      border-radius: var(--border-radius);
      margin-bottom: var(--space-sm);
      flex-wrap: wrap;
      align-items: center;
    }

    .format-btn {
      min-width: 36px;
      height: 32px;
      padding: 4px 8px;
      border: 1px solid var(--color-border);
      border-radius: 4px;
      background: var(--color-white);
      cursor: pointer;
      font-size: 0.95em;
      transition: all var(--transition-fast);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .format-btn:hover {
      background: var(--color-light);
      border-color: var(--color-primary);
    }

    .format-divider {
      width: 1px;
      height: 24px;
      background: var(--color-border);
      margin: 0 4px;
    }

    .format-hint {
      flex: 1;
      text-align: right;
      font-size: var(--font-size-sm);
      color: var(--color-text-subtle);
    }

    .g-textarea--code {
      font-family: var(--font-mono);
      font-size: 0.95rem;
      min-height: 140px;
    }

    /* Print */
    @media print {
      body { background: white; padding: 0; }
      .g-page-header, .controls-panel, .replacements-panel,
      .shuffle-toggle, .button-bar, .preview-header,
      .g-footer, .g-no-print { display: none !important; }
      .preview-panel { box-shadow: none; padding: 20px; }
      .preview-text { background: white; }
      .tool-container { padding: 0; }
      .print-footer {
        display: block !important;
        position: fixed;
        bottom: 20px;
        left: 0; right: 0;
        text-align: center;
        font-size: 10pt;
        color: #666;
        border-top: 1px solid #ddd;
        padding-top: 10px;
      }
    }

    .print-footer { display: none; }

    @media (max-width: 768px) {
      .button-bar { flex-direction: column; }
      .button-bar .g-btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="g-page-header">
    <div class="g-container">
      <div class="g-page-header__brand">Giesberg Diagnostik</div>
      <h1>Oberl&auml;ngen-Text-Generator</h1>
      <p>Diagnostik-Tool f&uuml;r okulomotorische Untersuchungen bei hochbegabten Kindern</p>
      <nav class="g-page-header__nav">
        <a href="../../portal/index.html">&larr; Zur&uuml;ck zum Portal</a>
        <a href="#" class="active">Oberl&auml;ngen-Generator</a>
      </nav>
    </div>
  </header>

  <main class="tool-container">

    <!-- Info -->
    <div class="g-info g-info--tip">
      <strong>Hinweis:</strong> Der Regler steuert, wie viel vom Buchstaben <strong>oben</strong> sichtbar bleibt.
      Bei 50% wird die untere H&auml;lfte abgeschnitten, bei 100% ist alles sichtbar, bei 30% nur der oberste Teil.
    </div>

    <!-- Controls -->
    <div class="controls-panel">
      <div class="control-grid">
        <div class="g-form-group">
          <label class="g-label">
            Sichtbarer Anteil (oben)
            <span class="value-badge" id="clipValue">100%</span>
          </label>
          <input type="range" class="g-range" id="clipSlider" min="0" max="100" value="100" step="1">
        </div>

        <div class="g-form-group">
          <label class="g-label">Schriftgr&ouml;&szlig;e (px)</label>
          <input type="number" class="g-input" id="fontSize" min="12" max="72" value="24" step="2">
        </div>

        <div class="g-form-group">
          <label class="g-label">Zeilenabstand</label>
          <input type="number" class="g-input" id="lineHeight" min="1" max="3" value="1.8" step="0.1">
        </div>

        <div class="g-form-group">
          <label class="g-label">Wortabstand (em)</label>
          <input type="number" class="g-input" id="wordSpacing" min="0" max="2" value="0" step="0.1">
        </div>

        <div class="g-form-group">
          <label class="g-label">Schriftart</label>
          <select class="g-select" id="fontFamily">
            <option value="Arial, sans-serif">Arial (Standard)</option>
            <option value="'Times New Roman', serif">Times New Roman</option>
            <option value="'Courier New', monospace">Courier New</option>
            <option value="Georgia, serif">Georgia</option>
            <option value="Verdana, sans-serif">Verdana</option>
            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
            <option value="Tahoma, sans-serif">Tahoma</option>
            <option value="'Trebuchet MS', sans-serif">Trebuchet MS</option>
          </select>
        </div>
      </div>

      <!-- Eingabetext -->
      <div class="g-form-group g-mt-lg">
        <label class="g-label">Eingabetext</label>
        <div class="format-toolbar">
          <button type="button" onclick="formatText('bold')" class="format-btn" title="Fett (Strg+B)"><strong>B</strong></button>
          <button type="button" onclick="formatText('italic')" class="format-btn" title="Kursiv (Strg+I)"><em>I</em></button>
          <button type="button" onclick="formatText('underline')" class="format-btn" title="Unterstrichen (Strg+U)"><u>U</u></button>
          <button type="button" onclick="formatText('bold-italic')" class="format-btn" title="Fett+Kursiv"><strong><em>BI</em></strong></button>
          <div class="format-divider"></div>
          <button type="button" onclick="insertLineBreak()" class="format-btn" title="Zeilenumbruch">&crarr;</button>
          <button type="button" onclick="insertParagraph()" class="format-btn" title="Neuer Absatz">&para;</button>
          <span class="format-hint">Markdown: **fett** *kursiv* __unterstrichen__</span>
        </div>
        <textarea class="g-textarea g-textarea--code" id="inputText" placeholder="Text eingeben...&#10;&#10;Markdown: **fett** *kursiv* __unterstrichen__ ***fett+kursiv***">Der Fuchs ruht. Die Katze springt hoch. Ein junger Adler schwebt majestätisch über den glitzernden Bergseen, während unten im Tal die fleißigen Bauern ihre Felder bestellen. Plötzlich erscheint am Horizont ein mysteriöses Leuchten, das die neugierigen Wissenschaftler in höchste Alarmbereitschaft versetzt und komplexe Untersuchungen erforderlich macht.</textarea>
      </div>
    </div>

    <!-- Ersetzungen -->
    <div class="replacements-panel">
      <h3 class="g-mb-md">Buchstaben-Ersetzungen</h3>
      <div class="replacement-grid">
        <label class="replacement-item"><input type="checkbox" id="replace_e" class="replace-checkbox"> <span>e &rarr; 3</span></label>
        <label class="replacement-item"><input type="checkbox" id="replace_a" class="replace-checkbox"> <span>a &rarr; 4</span></label>
        <label class="replacement-item"><input type="checkbox" id="replace_i" class="replace-checkbox"> <span>i &rarr; 1</span></label>
        <label class="replacement-item"><input type="checkbox" id="replace_o" class="replace-checkbox"> <span>o &rarr; 0</span></label>
        <label class="replacement-item"><input type="checkbox" id="replace_s" class="replace-checkbox"> <span>s &rarr; 5</span></label>
        <label class="replacement-item"><input type="checkbox" id="replace_t" class="replace-checkbox"> <span>t &rarr; 7</span></label>
      </div>
      <div class="custom-replacements">
        <div class="custom-replacement-row">
          <input type="text" id="custom_from_1" maxlength="5" placeholder="von">
          <span>&rarr;</span>
          <input type="text" id="custom_to_1" maxlength="5" placeholder="nach">
          <input type="checkbox" id="custom_active_1" class="replace-checkbox">
        </div>
        <div class="custom-replacement-row">
          <input type="text" id="custom_from_2" maxlength="5" placeholder="von">
          <span>&rarr;</span>
          <input type="text" id="custom_to_2" maxlength="5" placeholder="nach">
          <input type="checkbox" id="custom_active_2" class="replace-checkbox">
        </div>
      </div>
    </div>

    <!-- Shuffle -->
    <div class="shuffle-toggle">
      <input type="checkbox" id="shuffleToggle">
      <div>
        <label for="shuffleToggle">Buchstaben mischen (erster und letzter bleiben fix)</label>
        <div class="hint">Beispiel: &ldquo;Wort&rdquo; &rarr; &ldquo;Wrot&rdquo; | &ldquo;Beispiel&rdquo; &rarr; &ldquo;Bsieiepl&rdquo;</div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="button-bar">
      <button class="g-btn g-btn--primary" onclick="updatePreview()">Vorschau aktualisieren</button>
      <button class="g-btn g-btn--secondary" onclick="window.print()">Als PDF drucken</button>
      <button class="g-btn g-btn--outline" onclick="resetDefaults()">Zur&uuml;cksetzen</button>
    </div>

    <!-- Preview -->
    <div class="preview-panel">
      <div class="preview-header">
        <h2>Live-Vorschau</h2>
        <span class="preview-stats" id="statsDisplay">Bereit</span>
      </div>
      <div class="preview-text" id="previewText">
        Hier erscheint die Vorschau deines Textes...
      </div>
      <div class="print-footer">&copy; stefangiesberg.de | Stefan Giesberg</div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="g-footer g-no-print">
    <div class="g-container">
      <p>&copy; 2026 Stefan Giesberg | <a href="../../portal/index.html">Zur&uuml;ck zum Portal</a></p>
    </div>
  </footer>

  <script>
    // === VARIABLEN ===
    const clipSlider = document.getElementById('clipSlider');
    const clipValue = document.getElementById('clipValue');
    const fontSize = document.getElementById('fontSize');
    const lineHeight = document.getElementById('lineHeight');
    const wordSpacing = document.getElementById('wordSpacing');
    const fontFamily = document.getElementById('fontFamily');
    const inputText = document.getElementById('inputText');
    const previewText = document.getElementById('previewText');
    const statsDisplay = document.getElementById('statsDisplay');
    const replaceCheckboxes = document.querySelectorAll('.replace-checkbox');
    const shuffleToggle = document.getElementById('shuffleToggle');

    // === EVENT LISTENERS ===
    clipSlider.addEventListener('input', function() {
      clipValue.textContent = this.value + '%';
      updatePreview();
    });
    fontSize.addEventListener('input', updatePreview);
    lineHeight.addEventListener('input', updatePreview);
    wordSpacing.addEventListener('input', updatePreview);
    fontFamily.addEventListener('change', updatePreview);
    inputText.addEventListener('input', updatePreview);
    shuffleToggle.addEventListener('change', updatePreview);
    replaceCheckboxes.forEach(cb => cb.addEventListener('change', updatePreview));
    ['custom_from_1','custom_to_1','custom_from_2','custom_to_2'].forEach(id =>
      document.getElementById(id).addEventListener('input', updatePreview)
    );

    // Keyboard Shortcuts
    inputText.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'b') { e.preventDefault(); formatText('bold'); }
        else if (e.key === 'i') { e.preventDefault(); formatText('italic'); }
        else if (e.key === 'u') { e.preventDefault(); formatText('underline'); }
      }
    });

    // === FORMATIERUNG ===
    function formatText(type) {
      const ta = inputText;
      const start = ta.selectionStart, end = ta.selectionEnd;
      const sel = ta.value.substring(start, end);
      if (!sel.length) { alert('Bitte markiere zuerst den Text.'); return; }
      const wrap = {bold:'**',italic:'*',underline:'__','bold-italic':'***'}[type]||'';
      const fmt = wrap + sel + wrap;
      ta.value = ta.value.substring(0, start) + fmt + ta.value.substring(end);
      const np = start + fmt.length;
      ta.setSelectionRange(np, np);
      ta.focus();
      updatePreview();
    }

    function insertLineBreak() {
      const ta = inputText, p = ta.selectionStart;
      ta.value = ta.value.substring(0, p) + '\n' + ta.value.substring(p);
      ta.setSelectionRange(p+1, p+1); ta.focus(); updatePreview();
    }

    function insertParagraph() {
      const ta = inputText, p = ta.selectionStart;
      ta.value = ta.value.substring(0, p) + '\n\n' + ta.value.substring(p);
      ta.setSelectionRange(p+2, p+2); ta.focus(); updatePreview();
    }

    // === MARKDOWN PARSER ===
    function parseMarkdown(text) {
      text = text.replace(/\n\n/g, '</p><p style="margin-bottom:1em;">');
      text = text.replace(/\n/g, '<br>');
      text = text.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
      text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
      text = text.replace(/__(.*?)__/g, '<u>$1</u>');
      return '<p style="margin-bottom:1em;">' + text + '</p>';
    }

    // === SCRAMBLE ===
    function scrambleWord(word) {
      if (!shuffleToggle.checked || word.length <= 3) return word;
      const first = word[0], last = word[word.length-1];
      const mid = word.slice(1,-1).split('');
      for (let i = mid.length-1; i > 0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [mid[i], mid[j]] = [mid[j], mid[i]];
      }
      return first + mid.join('') + last;
    }

    // === ERSETZUNGEN ===
    function applyReplacementsToText(text) {
      let r = text;
      if (document.getElementById('replace_e').checked) r = r.replace(/e/gi,'3');
      if (document.getElementById('replace_a').checked) r = r.replace(/a/gi,'4');
      if (document.getElementById('replace_i').checked) r = r.replace(/i/gi,'1');
      if (document.getElementById('replace_o').checked) r = r.replace(/o/gi,'0');
      if (document.getElementById('replace_s').checked) r = r.replace(/s/gi,'5');
      if (document.getElementById('replace_t').checked) r = r.replace(/t/gi,'7');
      [1,2].forEach(n => {
        if (document.getElementById('custom_active_'+n).checked) {
          const f = document.getElementById('custom_from_'+n).value;
          const t = document.getElementById('custom_to_'+n).value;
          if (f && t) r = r.replace(new RegExp(f,'gi'), t);
        }
      });
      return r;
    }

    // === CLIP-PATH ===
    function calculateClipPath(pct) {
      return `polygon(0 0, 100% 0, 100% ${pct}%, 0 ${pct}%)`;
    }

    // === HAUPTFUNKTION: PREVIEW ===
    function updatePreview() {
      const text = inputText.value || 'Kein Text eingegeben.';
      let html = parseMarkdown(text);
      const clipPct = clipSlider.value;
      const clipPath = calculateClipPath(clipPct);

      // Stats
      const wc = text.trim().split(/\s+/).length;
      const cc = text.length;
      const sh = shuffleToggle.checked ? ' · gemischt' : '';
      statsDisplay.textContent = `${wc} Wörter · ${cc} Zeichen · ${clipPct}% sichtbar${sh}`;

      // Styling
      previewText.style.fontSize = fontSize.value + 'px';
      previewText.style.lineHeight = lineHeight.value;
      previewText.style.wordSpacing = wordSpacing.value + 'em';
      previewText.style.fontFamily = fontFamily.value;

      // Verarbeite Text-Nodes
      const tmp = document.createElement('div');
      tmp.innerHTML = html;

      function processTextNodes(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          let t = applyReplacementsToText(node.textContent);
          if (shuffleToggle.checked) {
            t = t.split(/(\s+)/).map(w => /\S/.test(w) ? scrambleWord(w) : w).join('');
          }
          node.textContent = t;
        } else if (node.nodeType === Node.ELEMENT_NODE) {
          Array.from(node.childNodes).forEach(processTextNodes);
        }
      }
      processTextNodes(tmp);

      // Clipping auf Wort-Ebene
      function wrapWords(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          const words = node.textContent.split(/(\s+)/);
          const frag = document.createDocumentFragment();
          words.forEach(w => {
            if (/\S/.test(w)) {
              const span = document.createElement('span');
              span.className = 'clipped-text';
              span.style.clipPath = clipPath;
              span.textContent = w;
              frag.appendChild(span);
            } else {
              frag.appendChild(document.createTextNode(w));
            }
          });
          node.parentNode.replaceChild(frag, node);
        } else if (node.nodeType === Node.ELEMENT_NODE && node.className !== 'clipped-text') {
          Array.from(node.childNodes).slice().forEach(wrapWords);
        }
      }
      wrapWords(tmp);

      previewText.innerHTML = tmp.innerHTML;
    }

    // === RESET ===
    function resetDefaults() {
      clipSlider.value = 100; clipValue.textContent = '100%';
      fontSize.value = 24; lineHeight.value = 1.8; wordSpacing.value = 0;
      fontFamily.value = "Arial, sans-serif";
      inputText.value = 'Der Fuchs ruht. Die Katze springt hoch. Ein junger Adler schwebt majestätisch über den glitzernden Bergseen, während unten im Tal die fleißigen Bauern ihre Felder bestellen. Plötzlich erscheint am Horizont ein mysteriöses Leuchten, das die neugierigen Wissenschaftler in höchste Alarmbereitschaft versetzt und komplexe Untersuchungen erforderlich macht.';
      document.querySelectorAll('.replace-checkbox').forEach(cb => cb.checked = false);
      ['custom_from_1','custom_to_1','custom_from_2','custom_to_2'].forEach(id =>
        document.getElementById(id).value = ''
      );
      shuffleToggle.checked = false;
      updatePreview();
    }

    // Initial
    updatePreview();
  </script>

</body>
</html>
